// Generated by CoffeeScript 1.9.3
(function() {
  var _, compile2SassAndJade, deleteFile, exec, fs, hassDir, iconv, jadeDir, log, parser, path, publicDir, readFileSync, sassDir, writeFileSync;

  exec = require('child_process');

  path = require('path');

  fs = require('fs');

  iconv = require('iconv-lite');

  _ = require('underscore');

  parser = require('./hassParser.coffee').parser;

  publicDir = path.join(__dirname, '..', '');

  hassDir = path.join(publicDir, 'demo/hass', 'layout.hass');

  sassDir = path.join(publicDir, 'demo/sass', 'header.sass');

  jadeDir = path.join(publicDir, 'demo/jade', 'header.jade');

  log = function(a) {
    return console.log(a);
  };

  deleteFile = function(files) {
    return _.each(files, function(val) {
      return fs.exists(val, function(exists) {
        if (exists) {
          return fs.unlink(val, function() {});
        }
      });
    });
  };

  readFileSync = function(hass_file) {
    var readedObj;
    readedObj = [];
    return fs.readFile(hass_file, function(err, data) {
      var str;
      if (err) {
        return log('2 读取文件fail' + err);
      } else {
        str = iconv.decode(data, 'utf-8');
        str = str.split('\n');
        return log(parser(str, hass_file));
      }
    });
  };


  /*
   * 解析文本
   *
  syntaxTree = parse str, hass_file
  simplifiedTree = pare str, hass_file
  
   * writeFile(sass_file, str)
   */

  writeFileSync = function(file, str) {
    var arr;
    arr = iconv.encode(str, 'utf-8');
    return fs.appendFile(file, arr + '\n', function(err) {
      if (err) {
        return log('4 写入文件fail' + err);
      } else {
        return log('4 写入文件ok');
      }
    });
  };

  compile2SassAndJade = function(hass_file, sass_file, jade_file) {
    return readFileSync(hass_file, sass_file, jade_file);
  };

  log('1 compile' + hassDir + ' once...');

  compile2SassAndJade(hassDir, sassDir, jadeDir);


  /*
  console.log 'watching file ...'
  
  fs.watchFile(hassDir, {
          persistent: true,
          interval: 1000
      },
      (curr, prev) ->
          console.log('the file changed, compile ...')
          compile2SassAndJade(hassDir, sassDir, jadeDir)
      );
   */

}).call(this);
